# Railway Deployment Guide - Backend Setup

## ğŸš€ Step-by-Step Railway Setup

### Part 1: Create Railway Project (5 minutes)

#### Step 1: Sign Up / Login to Railway
1. Go to https://railway.app/
2. Click **"Login"** or **"Start a New Project"**
3. Sign in with GitHub (recommended)
4. Authorize Railway to access your repositories

#### Step 2: Create New Project
1. Click **"New Project"** button
2. Select **"Deploy from GitHub repo"**
3. Choose **"BorisUrten/homelab_weather-app"** from the list
4. Railway will create the project

### Part 2: Add PostgreSQL Database

#### Step 1: Add Database Service
1. In your Railway project dashboard, click **"+ New"**
2. Select **"Database"**
3. Choose **"PostgreSQL"**
4. Railway will provision a PostgreSQL database (takes ~30 seconds)

#### Step 2: Note Database Details
The database will automatically get a `DATABASE_URL` variable. Railway handles this for you!

### Part 3: Configure Backend Service

#### Step 1: Add Backend Service
1. Click **"+ New"** again
2. Select **"GitHub Repo"**
3. Choose **"BorisUrten/homelab_weather-app"**
4. Railway will detect your repository

#### Step 2: Configure Service Settings

Click on the **backend service** card, then go to **"Settings"** tab:

**Root Directory:**
```
app
```
(This tells Railway where your backend code is)

**Build Command:** (Should auto-detect, but verify)
```
pip install -r requirements.txt
```

**Start Command:**
```
gunicorn -w 4 -b 0.0.0.0:$PORT api:app
```

**Health Check Path:**
```
/health
```

### Part 4: Set Environment Variables

Click on **"Variables"** tab and add these:

| Variable Name | Value | Notes |
|--------------|-------|-------|
| `DATABASE_URL` | *(Auto-generated by Railway)* | Reference the PostgreSQL service |
| `WEATHER_API_KEY` | `your_weatherapi_key_here` | Get from weatherapi.com |
| `CITY` | `Mississauga` | Or your preferred city |
| `COUNTRY` | `Canada` | Or your preferred country |
| `UPDATE_INTERVAL` | `300` | Seconds between updates |
| `LOG_LEVEL` | `INFO` | Logging level |
| `PORT` | `$PORT` | Railway provides this automatically |
| `FRONTEND_URL` | `https://homelab-weather-app.vercel.app` | Your Vercel URL (add after Vercel deploys) |

#### How to Reference DATABASE_URL:
1. Click **"+ New Variable"**
2. For `DATABASE_URL`:
   - Click **"Add Reference"**
   - Select your **PostgreSQL service**
   - Choose **"DATABASE_URL"**
   - This automatically links the database

### Part 5: Deploy Backend Worker (Data Collector)

You need TWO services from the same repo:
1. **Backend API** (already created above)
2. **Worker** (data collector)

#### Add Worker Service:
1. Click **"+ New"** in your project
2. Select **"GitHub Repo"**
3. Choose **"BorisUrten/homelab_weather-app"** again
4. Railway will create a second service

#### Configure Worker Settings:

Go to **Settings** tab:

**Service Name:** Change to `worker`

**Root Directory:**
```
app
```

**Start Command:**
```
python collector.py
```

**Environment Variables:** (Same as backend)
Copy all the same variables from the backend service, or use Railway's variable sharing feature.

### Part 6: Generate Public Domain (Backend API)

1. Go to your **backend service** (the one running `api.py`)
2. Click **"Settings"** tab
3. Scroll to **"Networking"**
4. Click **"Generate Domain"**
5. Railway will give you a URL like: `https://homelab-weather-app-production.up.railway.app`
6. **Copy this URL** - you'll need it for Vercel!

âš ï¸ **Important:** The worker service does NOT need a public domain (it just collects data).

### Part 7: Verify Deployment

#### Check Backend API:
Visit your Railway URL:
```
https://your-app.railway.app/health
```

Should return:
```json
{
  "status": "healthy",
  "timestamp": "2024-..."
}
```

#### Check Current Weather:
```
https://your-app.railway.app/api/weather/current
```

Should return weather data (after a few minutes for first collection).

#### Check Logs:
1. Click on **backend service**
2. Go to **"Deployments"** tab
3. Click on the latest deployment
4. View **"Deploy Logs"** and **"Build Logs"**

### Part 8: Configure Vercel with Railway URL

Now go back to **Vercel**:

1. Open your Vercel project
2. Go to **"Settings"** â†’ **"Environment Variables"**
3. Add/Update:
   ```
   NEXT_PUBLIC_API_URL=https://your-app.railway.app
   ```
   (Use the domain you generated in Part 6)
4. Click **"Save"**
5. Go to **"Deployments"** tab
6. Click **"Redeploy"** on the latest deployment

## ğŸ¯ Railway Settings Summary

### Backend API Service
```
Name: backend (or homelab_weather-app)
Root Directory: app
Start Command: gunicorn -w 4 -b 0.0.0.0:$PORT api:app
Health Check: /health
Public Domain: YES (generate one)
```

### Worker Service
```
Name: worker
Root Directory: app
Start Command: python collector.py
Health Check: None needed
Public Domain: NO
```

### Database Service
```
Type: PostgreSQL
Auto-provisioned by Railway
No configuration needed
```

## ğŸ” Troubleshooting

### Build Fails
- Check **"Build Logs"** in Railway
- Verify `requirements.txt` is correct
- Check Root Directory is set to `app`

### App Crashes on Start
- Check **"Deploy Logs"**
- Verify all environment variables are set
- Check `DATABASE_URL` is properly referenced

### No Weather Data
- Check **worker service logs**
- Verify `WEATHER_API_KEY` is correct
- Wait 5 minutes for first data collection
- Check database: Railway â†’ PostgreSQL â†’ Query tab:
  ```sql
  SELECT COUNT(*) FROM weather_data;
  ```

### CORS Errors from Frontend
- Verify `FRONTEND_URL` is set correctly in backend
- Check Vercel URL matches exactly (no trailing slash)
- Redeploy backend after changing env vars

## ğŸ“Š Final Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vercel         â”‚
â”‚  (Frontend)     â”‚
â”‚  Next.js 14     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ HTTPS
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Railway        â”‚â”€â”€â”€â”€â–¶â”‚  Railway        â”‚
â”‚  (Backend API)  â”‚     â”‚  (PostgreSQL)   â”‚
â”‚  Flask + Gunic. â”‚     â”‚  Database       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                       â–²
         â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  Railway        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  (Worker)       â”‚
â”‚  Data Collector â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ API Call
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WeatherAPI.com â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ‰ Success Checklist

- [ ] Railway project created
- [ ] PostgreSQL database added
- [ ] Backend API service configured
- [ ] Worker service configured
- [ ] All environment variables set
- [ ] Backend public domain generated
- [ ] Backend `/health` endpoint responds
- [ ] Backend `/api/weather/current` returns data
- [ ] Vercel environment variable updated
- [ ] Frontend successfully connects to backend

## ğŸ’¡ Pro Tips

1. **Use Railway CLI** for easier deployments:
   ```bash
   npm install -g @railway/cli
   railway login
   railway link
   ```

2. **Monitor Logs** in real-time:
   - Railway Dashboard â†’ Service â†’ "Deployments" â†’ "View Logs"

3. **Database Access**:
   - Railway â†’ PostgreSQL service â†’ "Data" tab
   - Or use the provided DATABASE_URL with any PostgreSQL client

4. **Cost**: Railway gives you $5 free credit monthly (enough for this project)

## ğŸ”— Useful Links

- Railway Dashboard: https://railway.app/dashboard
- Railway Docs: https://docs.railway.app/
- Your Project: https://railway.app/project/[your-project-id]

---

**Next Step**: After completing Railway setup, update Vercel environment variable and redeploy!
